<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Page View Count Test</title>
</head>
<body>
<article class="block">
    <div class="content">
        <h1 class="title">
            <a href="https://www.crudman.cn/posts/2022-summary1/">2022年度总结1</a>
        </h1>
    </div>
</article>
<article class="block">
    <div class="content">
        <h1 class="title">
            <a href="https://www.crudman.cn/posts/2022-summary2/">2022年度总结2</a>
        </h1>
    </div>
</article>
<article class="block">
    <div class="content">
        <h1 class="title">
            <a href="https://www.crudman.cn/posts/2022-summary3/">2022年度总结3</a>
        </h1>
    </div>
</article>
<article class="block">
    <div class="content">
        <h1 class="title">
            <a href="https://www.crudman.cn/posts/2022-summary4/">2022年度总结4</a>
        </h1>
    </div>
</article>

<div class="content">
    <!-- TODO 设计一个好看的404页面 -->
    <div class="columns is-mobile">
        <div class="column is-half is-offset-one-quarter">
            <div class="image is-4by3">
                <img src="https://bulma.io/images/placeholders/128x128.png" alt="405">
                <img src="https://bulma.io/images/placeholders/128x128.png" alt="40 4">
            </div>
        </div>
    </div>
</div>

<p>Site PV: <span id="site_pv">45</span></p>
<p>Site UV: <span id="site_uv">46</span></p>
<p>Page PV: <span class="page_pv">47</span></p>
<p>Page PV: <span class="page_pv">47</span></p>
<p>Page PV: <span class="page_pv">47</span></p>
<p>Page PV: <span class="page_pv">47</span></p>
<p>Page UV: <span id="page_uv">48</span></p>

<script>
    //页面流量统计入口
    async function count() {
        //首页：完整URL：https://www.crudman.cn/，pathname：/
        //分页：完整URL：https://www.crudman.cn/page/2/，pathname：/page/2/
        //文章页：完整URL：https://www.crudman.cn/posts/011-post/，pathname：/posts/011-post/
        //归档页：完整URL：https://www.crudman.cn/posts/，pathname：/posts/
        //分类页：完整URL：https://www.crudman.cn/categories/，pathname：/categories/
        //分类详情页：完整URL：https://www.crudman.cn/categories/life2222/，pathname：/categories/life2222/
        //标签页：完整URL：https://www.crudman.cn/tags/，pathname：/tags/
        //标签详情页：完整URL：https://www.crudman.cn/tags/cdn/，pathname：/tags/cdn/
        //关于页：完整URL：https://www.crudman.cn/about/，pathname：/about/
        //简历页：完整URL：https://www.crudman.cn/resume/，pathname：/resume/

        //返回基础 URL (https://www.crudman.cn/)
        let origin = window.location.origin;
        console.log('origin', origin);
        //返回域名部分 (www.crudman.cn)
        let domain = document.domain;
        console.log('domain', domain);

        //首先获取浏览器当前完整URL和pathname
        //let url = window.location.href;
        //let pathname = window.location.pathname;

        //let url = 'https://www.crudman.cn/';
        //let pathname = '/';

        //let url = 'https://www.crudman.cn/page/2/';
        //let pathname = '/page/2/';

        let url = 'https://www.crudman.cn/posts/2022-summary1/';
        let pathname = '/posts/2022-summary1/';

        //let url = 'https://www.crudman.cn/posts/';
        //let pathname = '/posts/';

        //let url = 'https://www.crudman.cn/categories/';
        //let pathname = '/categories/';

        //let url = 'https://www.crudman.cn/categories/life2222/';
        //let pathname = '/categories/life2222/';

        //let url = 'https://www.crudman.cn/tags/';
        //let pathname = '/tags/';

        //let url = 'https://www.crudman.cn/tags/cdn/';
        //let pathname = '/tags/cdn/';

        //let url = 'https://www.crudman.cn/about/';
        //let pathname = '/about/';

        //let url = 'https://www.crudman.cn/resume/';
        //let pathname = '/resume/';

        console.log('url', url);
        console.log('pathname', pathname);

        const reqData = buildReqData(url, pathname);
        let reqDataStr = JSON.stringify(reqData);

        console.log('request data', reqData);
        console.log('request data string', reqDataStr);

        let resData = await req(reqDataStr);
        console.log('response data', resData);
        console.log('response data str', JSON.stringify(resData));

        if(resData) {
            const code = resData.code;
            console.log('res code', code);
            //const sitePVEl = document.querySelector('span[id=site_pv]');
            const sitePVEl = document.querySelector('#site_pv');
            sitePVEl.innerHTML = resData.data.sitePV;
        }
        if(resData.data.pages) {
            const pagePVEls = document.querySelectorAll('.page_pv');
            console.log(pagePVEls);
            for(let i = 0; i < pagePVEls.length; i++) {
                if(resData.data.pages[i].pagePV) {
                    pagePVEls[i].innerHTML = resData.data.pages[i].pagePV;
                }
            }
        }
    }

    //根据pathname判断是首页（包括分页），归档页，分类页（包括分类详情页），标签页（包括标签详情页），关于页，简历页还是404页面
    function buildReqData(url, pathname) {
        let reqData = {};
        let urls = [];
        reqData.countType = '10';
        reqData.urls = urls;
        const img404 = document.querySelector('img[alt="404"]');
        if(img404) {
            //reqData.countType = '00';
            //return reqData;
            return null;
        }
        if(pathname === '/' || pathname.includes('/page/')) {
            const aList = Array.prototype.slice.call(document.querySelectorAll('article > div > h1 > a'), 0);
            aList.forEach(el => {
                urls.push(el.href);
            });
            return reqData;
        }
        if(pathname === '/posts/') {
            return reqData;
        }
        if(pathname.includes('/posts/')) {
            urls.push(url);
            reqData.countType = '11';
            return reqData;
        }
        return reqData;
    }

    //发送HTTP请求
    async function req(reqDataStr) {
        const url = 'http://127.0.0.1:8787/pvtest';
        let reqInit = {
            method: 'PUT',
            mode: 'cors',
            cache: 'default',
            referrerPolicy: 'no-referrer-when-downgrade',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
            },
            body: reqDataStr
        };
        try {
            let response = await fetch(url, reqInit);
            //对应答结果进行判断
            console.log('response status', response.status);
            console.log('response statusText',response.statusText);
            if(response.status === 200) {
                return await response.json();
            }
            return null;
        } catch (error) {
            console.log('put request failed', error);
            return null;
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', count);
    } else {
        count();
    }
</script>

</body>
</html>